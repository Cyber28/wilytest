name: benchmark-latex-build

on:
  workflow_dispatch:
  push:

jobs:
  benchmark:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        disable-diffpdf: ["", "1"]
        disable-synctex: ["1"]
        disable-pythontex: ["1"]
        docker-tag: ["v1.4.0"]
    steps:
      - name: pull image
        run: docker pull ghcr.io/jemand771/latex-build:${{ matrix.docker-tag }}
      - name: clone repo
        run: git clone https://github.com/DSczyrba/Vorlage-Latex
      - name: set key
        run: echo "key=${{ matrix.docker-tag }},${{ matrix.disable-diffpdf != '' }},${{ matrix.disable-synctex != '' }},${{ matrix.disable-pythontex != '' }}" >> $GITHUB_ENV
      - name: benchmark
        run: |
          echo elapsed=$(/usr/bin/time -f %e bash -c "for i in {0..1}; do docker run -u $(id -u ${USER}):$(id -g ${USER}) --rm -v \"$(pwd)/Vorlage-Latex/Latex:/latex\" ghcr.io/jemand771/latex-build:${{ matrix.docker-tag }} &> /dev/null; rm -rf Vorlage-Latex/Latex/.build; done" 2>&1) >> $GITHUB_ENV
      - name: save result
        run: echo ${{ env.key }},${{ env.elapsed }} > result.csv
      - name: upload result
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.key }}
          path: result.csv
  prepare-results:
    runs-on: ubuntu-latest
    needs: benchmark
    steps:
      - name: download artifacts
        uses: actions/download-artifact@v2
      - name: aggregate results
        run: find /home/runner/work/test/test -type f ! -name 'results.csv' -exec cat {} + > results.csv
      - name: upload super-results
        uses: actions/upload-artifact@v2
        with:
          name: results
          path: results.csv
  print-table:
    runs-on: ubuntu-latest
#    needs: prepare-results
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: "3.x"
      - run: pip install tabulate
      - uses: actions/download-artifact@v2
        with:
          name: results
      - run: |
          pwd
          ls -lah
          ls -lah *
      - run: cat results.csv | python latex-benchmark-parser.py
